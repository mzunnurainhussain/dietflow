<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DietFlow — Recommendations</title>
  <link rel="stylesheet" href="./assets/style.css"/>
</head>

<body>
<header>
  <div class="container nav">
    <div class="brand"><a href="./index.html">dietflow<span>.</span></a></div>
    <div class="links">
      <a href="./recommendations.html">recommendations</a>
      <a href="./plan.html">weekly plan</a>
    </div>
  </div>
</header>

<main class="container">
  <div class="sectionTitle">
    <h2>Recommendations</h2>
    <div class="hint" id="countInfo">Loading…</div>
  </div>

  <div class="filters">
    <div class="row">
      <input id="q" class="input" placeholder="Search: salad, chicken, rice..." />
      <select id="sort" class="select">
        <option value="score">Best score</option>
        <option value="calories">Lowest calories</option>
        <option value="protein">Highest protein</option>
      </select>

      <div class="sliderWrap">
        <label><span>Max calories</span><b id="calMaxVal">1200</b></label>
        <input id="calMax" type="range" min="200" max="2000" step="10" value="1200"/>
      </div>

      <div class="sliderWrap">
        <label><span>Min protein</span><b id="pMinVal">0</b></label>
        <input id="pMin" type="range" min="0" max="150" step="1" value="0"/>
      </div>

      <div class="sliderWrap">
        <label><span>Max carbs</span><b id="cMaxVal">200</b></label>
        <input id="cMax" type="range" min="0" max="300" step="5" value="200"/>
      </div>

      <div class="sliderWrap">
        <label><span>Max fat</span><b id="fMaxVal">120</b></label>
        <input id="fMax" type="range" min="0" max="200" step="5" value="120"/>
      </div>
    </div>
  </div>

  <div id="cards" class="cards"></div>

  <div class="footer">
    Data source:
    <code id="srcCode">loading…</code>
  </div>
</main>

<!-- PapaParse CDN -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
  // ---------------------------
  // ✅ SET YOUR CSV RAW URL HERE
  // ---------------------------
  // IMPORTANT: must be raw.githubusercontent.com (NOT github.com/.../blob/...)
  const CSV_URL =
    "https://raw.githubusercontent.com/mzunnurainhussain/dietflow/main/top_recommendations_lunch.csv";

  // show in footer
  document.getElementById("srcCode").textContent = CSV_URL;

  // ---------- helpers ----------
  const toNum = (v) => {
    const n = Number(String(v ?? "").trim());
    return Number.isFinite(n) ? n : 0;
  };

  const esc = (s) => String(s ?? "").replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));

  async function loadCsv(url){
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`Failed to load ${url}: ${res.status}`);
    const text = await res.text();
    const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
    return parsed.data || [];
  }

  function recipeCard(r){
    return `
      <div class="recipe">
        <div class="name">${esc(r.name)}</div>
        <div class="cat">${esc(r.category || "")}</div>
        <div class="chips">
          <span class="chip">Cal: <b>${r.calories}</b></span>
          <span class="chip">P: <b>${r.protein}</b></span>
          <span class="chip">C: <b>${r.carbs}</b></span>
          <span class="chip">F: <b>${r.fat}</b></span>
          ${Number.isFinite(r.score) ? `<span class="chip score">Score: <b>${r.score}</b></span>` : ""}
        </div>
      </div>
    `;
  }

  // ---------- init ----------
  async function init(){
    const holder = document.getElementById("cards");
    const info = document.getElementById("countInfo");

    const rows = await loadCsv(CSV_URL);

    let data = rows
      .map(r => ({
        // supports Name/name etc
        name: (r.Name ?? r.name ?? "").trim(),
        category: (r.Category ?? r.category ?? "").trim(),
        calories: toNum(r.Calories ?? r.calories),
        protein: toNum(r.Protein ?? r.protein),
        carbs: toNum(r.Carbs ?? r.carbs),
        fat: toNum(r.Fat ?? r.fat),
        score: toNum(r.Score ?? r.final_score ?? r.score)
      }))
      .filter(x => x.name);

    const state = {
      q: "",
      calMax: 1200,
      pMin: 0,
      cMax: 200,
      fMax: 120,
      sort: "score"
    };

    const bind = (id, key, transform = (v) => v) => {
      const el = document.getElementById(id);
      el.addEventListener("input", () => {
        state[key] = transform(el.value);
        render();
      });
    };

    bind("q", "q", (v)=> String(v));
    bind("calMax", "calMax", (v)=> Number(v));
    bind("pMin", "pMin", (v)=> Number(v));
    bind("cMax", "cMax", (v)=> Number(v));
    bind("fMax", "fMax", (v)=> Number(v));

    document.getElementById("sort").addEventListener("change", (e) => {
      state.sort = e.target.value;
      render();
    });

    const setLabel = (id, value) => {
      const el = document.getElementById(id + "Val");
      if(el) el.textContent = value;
    };

    function render(){
      setLabel("calMax", state.calMax);
      setLabel("pMin", state.pMin);
      setLabel("cMax", state.cMax);
      setLabel("fMax", state.fMax);

      const q = state.q.trim().toLowerCase();
      let out = data.filter(r => {
        const hay = (r.name + " " + r.category).toLowerCase();
        const okQ = q ? hay.includes(q) : true;
        return okQ &&
          r.calories <= state.calMax &&
          r.protein >= state.pMin &&
          r.carbs <= state.cMax &&
          r.fat <= state.fMax;
      });

      if(state.sort === "score") out.sort((a,b)=> (b.score||0)-(a.score||0));
      if(state.sort === "calories") out.sort((a,b)=> a.calories-b.calories);
      if(state.sort === "protein") out.sort((a,b)=> b.protein-a.protein);

      out = out.slice(0, 60);
      info.textContent = `${out.length} results (showing top 60)`;
      holder.innerHTML = out.map(recipeCard).join("");
    }

    render();
  }

  init().catch(err => {
    document.getElementById("countInfo").textContent = "Failed to load CSV";
    document.getElementById("cards").innerHTML =
      `<div class="card"><h3>Error</h3><p>${esc(err.message)}</p></div>`;
  });
</script>
</body>
</html>
